(function(e,f){typeof exports=="object"&&typeof module<"u"?module.exports=f(require("vue")):typeof define=="function"&&define.amd?define(["vue"],f):(e=typeof globalThis<"u"?globalThis:e||self,e.bigFileUpload=f(e.Vue))})(this,function(e){"use strict";const f=(c,o)=>{const r=c.__vccOpts||c;for(const[t,l]of o)r[t]=l;return r},F=["onKeydown"],x={key:0},B={key:1,class:"progress progress-striped active"},U=["aria-valuenow"],E=[f(Object.assign({name:"BigFileUpload"},{__name:"index",props:{options:{type:Object,default:()=>({checkFileUrl:"",uploadFileUrl:"",mergeFileUrl:"",chunkSize:1024*1024*5})}},setup(c){const o=e.shallowRef(),r=new Worker("../worker.js"),t=[],l=c,a=e.ref([]);console.log(l.options);const S=()=>{y()},y=()=>{o.value.value="",o.value.click()},$=p=>{const s=p.target.files;console.log(p,"e");const n=s[0];console.log(n.name),n.state="pending",a.value=[...a.value,n];const d=Math.ceil(n.size/l.options.chunkSize);console.log(d,"total"),t.push(...Array.from({length:d},(_,g)=>n.slice(g*l.options.chunkSize,(g+1)*l.options.chunkSize))),console.log(t,"chunks"),r.postMessage({chunks:t,filename:n.name}),console.log(r,"worker")},h=e.ref(0);return r.onmessage=async function(p){console.log(p,"e"),o.value.value="";const{filename:s,hash:n}=p.data,d=await fetch(`${l.options.checkFileUrl}?hash=${n}`),{files:_}=await d.json(),g=new Set(_),k=t.map((i,m)=>({chunk:i,index:m})).filter(({index:i})=>!g.has(`${s}-${i}`));for(const{chunk:i,index:m}of k){const u=new FormData;u.append("filename",s),u.append("hash",n),u.append("index",m),u.append("file",i),await fetch(l.options.uploadFileUrl,{method:"POST",body:u}),t.length===k.length?h.value=((m+1)/t.length).toFixed(2)*100:h.value=((m+1+(t.length-k.length))/t.length).toFixed(2)*100}await fetch(`${l.options.mergeFileUrl}?hash=${n}&filename=${s}`),t.length=0;const w=a.value.findIndex(i=>i.name===s);w!==-1&&(a.value[w].state="uploaded"),a.value=[...a.value]},(p,s)=>(e.openBlock(),e.createElementBlock("div",null,[e.createElementVNode("button",{onClick:y,onKeydown:e.withKeys(e.withModifiers(S,["self"]),["enter","space"])},"开始上传",40,F),e.createElementVNode("input",{style:{display:"none"},ref_key:"inputRef",ref:o,type:"file",id:"file",multiple:!0,onChange:$,onClick:s[0]||(s[0]=e.withModifiers(()=>{},["stop"]))},null,544),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(a.value,(n,d)=>(e.openBlock(),e.createElementBlock("li",{class:"list-group-item",key:d},[e.createElementVNode("span",null,e.toDisplayString(n.name),1),n.state==="pending"?(e.openBlock(),e.createElementBlock("span",x,"上传进度")):e.createCommentVNode("",!0),n.state==="pending"?(e.openBlock(),e.createElementBlock("div",B,[e.createElementVNode("div",{role:"progressbar",class:"progress-bar",style:e.normalizeStyle(`width:${h.value}%;`),"aria-valuenow":h.value,"aria-valuemin":"0","aria-valuemax":"100"},e.toDisplayString(h.value)+"%",13,U)])):e.createCommentVNode("",!0)]))),128))]))}}),[["__scopeId","data-v-06a4eff6"]])];return{install:function(c){E.forEach(o=>{c.component(o.name,o)})}}});
