(function(e,m){typeof exports=="object"&&typeof module<"u"?module.exports=m(require("vue")):typeof define=="function"&&define.amd?define(["vue"],m):(e=typeof globalThis<"u"?globalThis:e||self,e.bigFileUpload=m(e.Vue))})(this,function(e){"use strict";const m=(o,s)=>{const n=o.__vccOpts||o;for(const[a,t]of s)n[a]=t;return n},$={class:"progress progress-striped active"},x=["aria-valuenow"],C=m(Object.assign({name:"Progress"},{__name:"index",props:{percentage:{type:Number,default:0}},setup(o){return(s,n)=>(e.openBlock(),e.createElementBlock("div",null,[e.createElementVNode("div",$,[e.createElementVNode("div",{role:"progressbar",class:"progress-bar",style:e.normalizeStyle(`width:${o.percentage}%;`),"aria-valuenow":o.percentage,"aria-valuemin":"0","aria-valuemax":"100"},e.toDisplayString(o.percentage)+"%",13,x)])]))}}),[["__scopeId","data-v-fc41b854"]]),B={class:"list-group"},b=["tabindex"],U={class:"list-group-item-info"},I={key:0},V=["onClick"],v=m({__name:"upload-list",props:{uploadFiles:{type:Array,default:()=>[]},percentage:{type:Number,default:0}},emits:["removeFile"],setup(o,{emit:s}){const n=s;function a(t){if(t.state==="pending"){alert("文件正在上传中，请稍后再删除");return}n("removeFile",t)}return(t,f)=>(e.openBlock(),e.createElementBlock("ul",B,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.uploadFiles,(i,k)=>(e.openBlock(),e.createElementBlock("li",{class:"list-group-item",key:k,tabindex:k},[e.createElementVNode("div",U,[e.createElementVNode("span",null,e.toDisplayString(i.name),1),i.state==="pending"?(e.openBlock(),e.createElementBlock("span",I,"上传进度")):e.createCommentVNode("",!0),e.createElementVNode("label",{class:"list-group-item-label",onClick:E=>a(i)},"x",8,V)]),i.state==="pending"?(e.openBlock(),e.createBlock(C,{key:0,percentage:Number(o.percentage)},null,8,["percentage"])):e.createCommentVNode("",!0)],8,b))),128))]))}},[["__scopeId","data-v-a3099391"]]),R=["onKeydown"],S=m({__name:"upload-content",props:{onChange:{type:Function,default:()=>{}}},setup(o){const s=e.shallowRef(),n=()=>{a()},a=()=>{s.value.value="",s.value.click()};return(t,f)=>(e.openBlock(),e.createElementBlock("div",null,[e.createElementVNode("button",{class:"uploadButton",onClick:a,onKeydown:e.withKeys(e.withModifiers(n,["self"]),["enter","space"])},"+ 点击上传",40,R),e.createElementVNode("input",{style:{display:"none"},ref_key:"inputRef",ref:s,type:"file",id:"file",multiple:!0,onChange:f[0]||(f[0]=(...i)=>o.onChange&&o.onChange(...i)),onClick:f[1]||(f[1]=e.withModifiers(()=>{},["stop"]))},null,544)]))}},[["__scopeId","data-v-cc48dd66"]]),T=[Object.assign({name:"BigFileUpload"},{__name:"index",props:{options:{type:Object,default:()=>({checkFileUrl:"",uploadFileUrl:"",mergeFileUrl:"",chunkSize:1024*1024*5,CONCURRENT_LIMIT:5})},onChange:{type:Function,default:()=>{}},fileList:{type:Array,default:()=>[]}},setup(o){const s=new Worker("../worker.js"),n=[],a=o,t=e.ref([]),f=async d=>{const r=d.target.files[0];r.state="pending",t.value=[...t.value,r];const _=Math.ceil(r.size/a.options.chunkSize);n.push(...Array.from({length:_},(g,p)=>r.slice(p*a.options.chunkSize,(p+1)*a.options.chunkSize))),console.log(n,"chunks"),s.postMessage({chunks:n,filename:r.name}),console.log(s,"worker")},i=e.ref(0);s.onmessage=async function(d){const{filename:c,hash:r}=d.data,_=await fetch(`${a.options.checkFileUrl}?hash=${r}`),{files:g,isExist:p}=await _.json();let h=t.value.findIndex(l=>l.name===c);if(p&&g.length===0&&t.value[h].state==="uploaded"){t.value=[...t.value.filter(l=>l.state!=="pending")],alert("文件已上传过，无需重复上传");return}const u=new Set(g),N=n.map((l,w)=>({chunk:l,index:w})).filter(({index:l})=>!u.has(`${c}-${l}`)),F=a.options.CONCURRENT_LIMIT,y=N.length;for(let l=0;l<y;l+=F)await Promise.all(N.slice(l,l+F).map((w,M)=>k(w.chunk,l+M,c,r,y))),console.log(`已上传 ${Math.min(l+F,y)}/${y}`);await fetch(`${a.options.mergeFileUrl}?hash=${r}&filename=${c}`),n.length=0,h=t.value.findIndex(l=>l.name===c),h!==-1&&(t.value[h].state="uploaded"),t.value=[...t.value],i.value=0,a.onChange(t.value[h],t.value,"add"),console.log("所有分片上传完毕，文件已合并")};const k=async(d,c,r,_,g)=>{const p=new FormData;return p.append("filename",r),p.append("hash",_),p.append("index",c),p.append("file",d),new Promise(h=>{fetch(a.options.uploadFileUrl,{method:"POST",body:p}).then(u=>{if(console.log("上传分片:",c,"响应状态:",u.status),u.status===200)return h(u.json());throw new Error("网络错误")}).then(u=>{n.length===g?i.value=((c+1)/n.length).toFixed(2)*100:i.value=((c+1+(n.length-g))/n.length).toFixed(2)*100}).catch(u=>{console.error("上传失败:",u)})})},E=d=>{console.log(d,"file"),t.value=[...t.value.filter(c=>c.name!==d.name)],a.onChange(d,t.value,"remove")};return(d,c)=>(e.openBlock(),e.createElementBlock("div",null,[e.createVNode(S,{"on-change":f}),e.createVNode(v,{uploadFiles:t.value,percentage:i.value,onRemoveFile:E},null,8,["uploadFiles","percentage"])]))}}),C];return{install:function(o){T.forEach(s=>{o.component(s.name,s)})}}});
