(function(e,f){typeof exports=="object"&&typeof module<"u"?module.exports=f(require("vue")):typeof define=="function"&&define.amd?define(["vue"],f):(e=typeof globalThis<"u"?globalThis:e||self,e.bigFileUpload=f(e.Vue))})(this,function(e){"use strict";const f=(a,r)=>{const l=a.__vccOpts||a;for(const[s,i]of r)l[s]=i;return l},b={class:"progress progress-striped active"},x=["aria-valuenow"],N=f(Object.assign({name:"Progress"},{__name:"index",props:{percentage:{type:Number,default:0}},setup(a){return(r,l)=>(e.openBlock(),e.createElementBlock("div",null,[e.createElementVNode("div",b,[e.createElementVNode("div",{role:"progressbar",class:"progress-bar",style:e.normalizeStyle(`width:${a.percentage}%;`),"aria-valuenow":a.percentage,"aria-valuemin":"0","aria-valuemax":"100"},e.toDisplayString(a.percentage)+"%",13,x)])]))}}),[["__scopeId","data-v-fc41b854"]]),B={class:"list-group"},U=["tabindex"],I={class:"list-group-item-info"},V={key:0},v=["onClick"],R=f({__name:"upload-list",props:{uploadFiles:{type:Array,default:()=>[]},percentage:{type:Number,default:0}},emits:["removeFile"],setup(a,{emit:r}){const l=r;function s(i){if(i.state==="pending"){alert("文件正在上传中，请稍后再删除");return}l("removeFile",i)}return(i,t)=>(e.openBlock(),e.createElementBlock("ul",B,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(a.uploadFiles,(p,k)=>(e.openBlock(),e.createElementBlock("li",{class:"list-group-item",key:k,tabindex:k},[e.createElementVNode("div",I,[e.createElementVNode("span",null,e.toDisplayString(p.name),1),p.state==="pending"?(e.openBlock(),e.createElementBlock("span",V,"上传进度")):e.createCommentVNode("",!0),e.createElementVNode("label",{class:"list-group-item-label",onClick:y=>s(p)},"x",8,v)]),p.state==="pending"?(e.openBlock(),e.createBlock(N,{key:0,percentage:Number(a.percentage)},null,8,["percentage"])):e.createCommentVNode("",!0)],8,U))),128))]))}},[["__scopeId","data-v-40492e41"]]),j=["onKeydown"],S=f({__name:"upload-content",props:{onChange:{type:Function,default:()=>{}}},setup(a){const r=e.shallowRef(),l=()=>{s()},s=()=>{r.value.value="",r.value.click()};return(i,t)=>(e.openBlock(),e.createElementBlock("div",null,[e.createElementVNode("button",{class:"uploadButton",onClick:s,onKeydown:e.withKeys(e.withModifiers(l,["self"]),["enter","space"])},"+ 点击上传",40,j),e.createElementVNode("input",{style:{display:"none"},ref_key:"inputRef",ref:r,type:"file",id:"file",multiple:!0,onChange:t[0]||(t[0]=(...p)=>a.onChange&&a.onChange(...p)),onClick:t[1]||(t[1]=e.withModifiers(()=>{},["stop"]))},null,544)]))}},[["__scopeId","data-v-d97b4021"]]),T=[Object.assign({name:"BigFileUpload"},{__name:"index",props:{options:{type:Object,default:()=>({checkFileUrl:"",uploadFileUrl:"",mergeFileUrl:"",chunkSize:1024*1024*5,CONCURRENT_LIMIT:5})},onChange:{type:Function,default:()=>{}},fileList:{type:Array,default:()=>[]}},setup(a){const r=new Worker("../worker.js"),l=[],s=a;let i=null;const t=e.ref([]);let p=[];const k=async d=>{const n=d.target.files;if(!n||n.length===0)return;console.log(n,"file"),i=n[0];for(let u=0;u<n.length;u++){const c=n[u];c.state="pending",p.push(c)}t.value=[...t.value,i];const h=Math.ceil(i.size/s.options.chunkSize);l.push(...Array.from({length:h},(u,c)=>i.slice(c*s.options.chunkSize,(c+1)*s.options.chunkSize))),console.log(l,"chunks"),r.postMessage({chunks:l,filename:i.name})},y=e.ref(0);r.onmessage=async function(d){const{filename:n,hash:h}=d.data,u=await fetch(`${s.options.checkFileUrl}?hash=${h}`),{files:c,isExist:g}=await u.json();let _=t.value.findIndex(o=>o.name===n);if(g&&c.length===0&&t.value[_].state==="uploaded"){t.value=[...t.value.filter(o=>o.state!=="pending")],alert("文件已上传过，无需重复上传");return}const m=new Set(c),$=l.map((o,w)=>({chunk:o,index:w})).filter(({index:o})=>!m.has(`${n}-${o}`)),C=s.options.CONCURRENT_LIMIT,F=$.length;for(let o=0;o<F;o+=C)await Promise.all($.slice(o,o+C).map((w,z)=>M(w.chunk,o+z,n,h,F))),console.log(`已上传 ${Math.min(o+C,F)}/${F}`);await fetch(`${s.options.mergeFileUrl}?hash=${h}&filename=${n}`),l.length=0,_=t.value.findIndex(o=>o.name===n),_!==-1&&(t.value[_].state="uploaded"),t.value=[...t.value],y.value=0;const E=p.filter((o,w)=>o.name!==n);if(console.log("待上传文件:",E),p=[],E.length>0){k({target:{files:E}});return}s.onChange(t.value[_],t.value,"add"),console.log("所有分片上传完毕，文件已合并")};const M=async(d,n,h,u,c)=>{const g=new FormData;return g.append("filename",h),g.append("hash",u),g.append("index",n),g.append("file",d),new Promise(_=>{fetch(s.options.uploadFileUrl,{method:"POST",body:g}).then(m=>{if(console.log("上传分片:",n,"响应状态:",m.status),m.status===200)return _(m.json());throw new Error("网络错误")}).then(m=>{l.length===c?y.value=((n+1)/l.length).toFixed(2)*100:y.value=((n+1+(l.length-c))/l.length).toFixed(2)*100}).catch(m=>{console.error("上传失败:",m)})})},O=d=>{t.value=[...t.value.filter(n=>n.name!==d.name)],s.onChange(d,t.value,"remove")};return(d,n)=>(e.openBlock(),e.createElementBlock("div",null,[e.createVNode(S,{"on-change":k}),e.createVNode(R,{uploadFiles:t.value,percentage:y.value,onRemoveFile:O},null,8,["uploadFiles","percentage"])]))}}),N];return{install:function(a){T.forEach(r=>{a.component(r.name,r)})}}});
