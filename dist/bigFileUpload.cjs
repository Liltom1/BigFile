"use strict";const e=require("vue"),C=(a,r)=>{const l=a.__vccOpts||a;for(const[s,c]of r)l[s]=c;return l},$={class:"progress progress-striped active"},I=["aria-valuenow"],U=Object.assign({name:"Progress"},{__name:"index",props:{percentage:{type:Number,default:0}},setup(a){return(r,l)=>(e.openBlock(),e.createElementBlock("div",null,[e.createElementVNode("div",$,[e.createElementVNode("div",{role:"progressbar",class:"progress-bar",style:e.normalizeStyle(`width:${a.percentage}%;`),"aria-valuenow":a.percentage,"aria-valuemin":"0","aria-valuemax":"100"},e.toDisplayString(a.percentage)+"%",13,I)])]))}}),N=C(U,[["__scopeId","data-v-fc41b854"]]),V={class:"list-group"},R=["tabindex"],S={class:"list-group-item-info"},j={key:0},M=["onClick"],O={__name:"upload-list",props:{uploadFiles:{type:Array,default:()=>[]},percentage:{type:Number,default:0}},emits:["removeFile"],setup(a,{emit:r}){const l=r;function s(c){if(c.state==="pending"){alert("文件正在上传中，请稍后再删除");return}l("removeFile",c)}return(c,t)=>(e.openBlock(),e.createElementBlock("ul",V,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(a.uploadFiles,(u,v)=>(e.openBlock(),e.createElementBlock("li",{class:"list-group-item",key:v,tabindex:v},[e.createElementVNode("div",S,[e.createElementVNode("span",null,e.toDisplayString(u.name),1),u.state==="pending"?(e.openBlock(),e.createElementBlock("span",j,"上传进度")):e.createCommentVNode("",!0),e.createElementVNode("label",{class:"list-group-item-label",onClick:_=>s(u)},"x",8,M)]),u.state==="pending"?(e.openBlock(),e.createBlock(N,{key:0,percentage:Number(a.percentage)},null,8,["percentage"])):e.createCommentVNode("",!0)],8,R))),128))]))}},T=C(O,[["__scopeId","data-v-40492e41"]]),z=["onKeydown"],L={__name:"upload-content",props:{onChange:{type:Function,default:()=>{}}},setup(a){const r=e.shallowRef(),l=()=>{s()},s=()=>{r.value.value="",r.value.click()};return(c,t)=>(e.openBlock(),e.createElementBlock("div",null,[e.createElementVNode("button",{class:"uploadButton",onClick:s,onKeydown:e.withKeys(e.withModifiers(l,["self"]),["enter","space"])},"+ 点击上传",40,z),e.createElementVNode("input",{style:{display:"none"},ref_key:"inputRef",ref:r,type:"file",id:"file",multiple:!0,onChange:t[0]||(t[0]=(...u)=>a.onChange&&a.onChange(...u)),onClick:t[1]||(t[1]=e.withModifiers(()=>{},["stop"]))},null,544)]))}},P=C(L,[["__scopeId","data-v-d97b4021"]]),D=Object.assign({name:"BigFileUpload"},{__name:"index",props:{options:{type:Object,default:()=>({checkFileUrl:"",uploadFileUrl:"",mergeFileUrl:"",chunkSize:1024*1024*5,CONCURRENT_LIMIT:5})},onChange:{type:Function,default:()=>{}},fileList:{type:Array,default:()=>[]}},setup(a){const r=new Worker("../worker.js"),l=[],s=a;let c=null;const t=e.ref([]);let u=[];const v=async p=>{const n=p.target.files;if(!n||n.length===0)return;console.log(n,"file"),c=n[0];for(let d=0;d<n.length;d++){const i=n[d];i.state="pending",u.push(i)}t.value=[...t.value,c];const h=Math.ceil(c.size/s.options.chunkSize);l.push(...Array.from({length:h},(d,i)=>c.slice(i*s.options.chunkSize,(i+1)*s.options.chunkSize))),console.log(l,"chunks"),r.postMessage({chunks:l,filename:c.name})},_=e.ref(0);r.onmessage=async function(p){const{filename:n,hash:h}=p.data,d=await fetch(`${s.options.checkFileUrl}?hash=${h}`),{files:i,isExist:g}=await d.json();let f=t.value.findIndex(o=>o.name===n);if(g&&i.length===0&&t.value[f].state==="uploaded"){t.value=[...t.value.filter(o=>o.state!=="pending")],alert("文件已上传过，无需重复上传");return}const m=new Set(i),E=l.map((o,y)=>({chunk:o,index:y})).filter(({index:o})=>!m.has(`${n}-${o}`)),F=s.options.CONCURRENT_LIMIT,k=E.length;for(let o=0;o<k;o+=F)await Promise.all(E.slice(o,o+F).map((y,x)=>b(y.chunk,o+x,n,h,k))),console.log(`已上传 ${Math.min(o+F,k)}/${k}`);await fetch(`${s.options.mergeFileUrl}?hash=${h}&filename=${n}`),l.length=0,f=t.value.findIndex(o=>o.name===n),f!==-1&&(t.value[f].state="uploaded"),t.value=[...t.value],_.value=0;const w=u.filter((o,y)=>o.name!==n);if(console.log("待上传文件:",w),u=[],w.length>0){v({target:{files:w}});return}s.onChange(t.value[f],t.value,"add"),console.log("所有分片上传完毕，文件已合并")};const b=async(p,n,h,d,i)=>{const g=new FormData;return g.append("filename",h),g.append("hash",d),g.append("index",n),g.append("file",p),new Promise(f=>{fetch(s.options.uploadFileUrl,{method:"POST",body:g}).then(m=>{if(console.log("上传分片:",n,"响应状态:",m.status),m.status===200)return f(m.json());throw new Error("网络错误")}).then(m=>{l.length===i?_.value=((n+1)/l.length).toFixed(2)*100:_.value=((n+1+(l.length-i))/l.length).toFixed(2)*100}).catch(m=>{console.error("上传失败:",m)})})},B=p=>{t.value=[...t.value.filter(n=>n.name!==p.name)],s.onChange(p,t.value,"remove")};return(p,n)=>(e.openBlock(),e.createElementBlock("div",null,[e.createVNode(P,{"on-change":v}),e.createVNode(T,{uploadFiles:t.value,percentage:_.value,onRemoveFile:B},null,8,["uploadFiles","percentage"])]))}}),K=[D,N],A=function(a){K.forEach(r=>{a.component(r.name,r)})},q={install:A};module.exports=q;
