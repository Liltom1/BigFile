"use strict";const e=require("vue"),w=(o,s)=>{const n=o.__vccOpts||o;for(const[a,t]of s)n[a]=t;return n},B={class:"progress progress-striped active"},$=["aria-valuenow"],x=Object.assign({name:"Progress"},{__name:"index",props:{percentage:{type:Number,default:0}},setup(o){return(s,n)=>(e.openBlock(),e.createElementBlock("div",null,[e.createElementVNode("div",B,[e.createElementVNode("div",{role:"progressbar",class:"progress-bar",style:e.normalizeStyle(`width:${o.percentage}%;`),"aria-valuenow":o.percentage,"aria-valuemin":"0","aria-valuemax":"100"},e.toDisplayString(o.percentage)+"%",13,$)])]))}}),E=w(x,[["__scopeId","data-v-fc41b854"]]),b={class:"list-group"},I=["tabindex"],U={class:"list-group-item-info"},V={key:0},R=["onClick"],S={__name:"upload-list",props:{uploadFiles:{type:Array,default:()=>[]},percentage:{type:Number,default:0}},emits:["removeFile"],setup(o,{emit:s}){const n=s;function a(t){if(t.state==="pending"){alert("文件正在上传中，请稍后再删除");return}n("removeFile",t)}return(t,m)=>(e.openBlock(),e.createElementBlock("ul",b,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.uploadFiles,(r,v)=>(e.openBlock(),e.createElementBlock("li",{class:"list-group-item",key:v,tabindex:v},[e.createElementVNode("div",U,[e.createElementVNode("span",null,e.toDisplayString(r.name),1),r.state==="pending"?(e.openBlock(),e.createElementBlock("span",V,"上传进度")):e.createCommentVNode("",!0),e.createElementVNode("label",{class:"list-group-item-label",onClick:F=>a(r)},"x",8,R)]),r.state==="pending"?(e.openBlock(),e.createBlock(E,{key:0,percentage:Number(o.percentage)},null,8,["percentage"])):e.createCommentVNode("",!0)],8,I))),128))]))}},M=w(S,[["__scopeId","data-v-a3099391"]]),O=["onKeydown"],T={__name:"upload-content",props:{onChange:{type:Function,default:()=>{}}},setup(o){const s=e.shallowRef(),n=()=>{a()},a=()=>{s.value.value="",s.value.click()};return(t,m)=>(e.openBlock(),e.createElementBlock("div",null,[e.createElementVNode("button",{class:"uploadButton",onClick:a,onKeydown:e.withKeys(e.withModifiers(n,["self"]),["enter","space"])},"+ 点击上传",40,O),e.createElementVNode("input",{style:{display:"none"},ref_key:"inputRef",ref:s,type:"file",id:"file",multiple:!0,onChange:m[0]||(m[0]=(...r)=>o.onChange&&o.onChange(...r)),onClick:m[1]||(m[1]=e.withModifiers(()=>{},["stop"]))},null,544)]))}},j=w(T,[["__scopeId","data-v-cc48dd66"]]),z=Object.assign({name:"BigFileUpload"},{__name:"index",props:{options:{type:Object,default:()=>({checkFileUrl:"",uploadFileUrl:"",mergeFileUrl:"",chunkSize:1024*1024*5,CONCURRENT_LIMIT:5})},onChange:{type:Function,default:()=>{}},fileList:{type:Array,default:()=>[]}},setup(o){const s=new Worker("../worker.js"),n=[],a=o,t=e.ref([]),m=async u=>{const i=u.target.files[0];i.state="pending",t.value=[...t.value,i];const f=Math.ceil(i.size/a.options.chunkSize);n.push(...Array.from({length:f},(g,p)=>i.slice(p*a.options.chunkSize,(p+1)*a.options.chunkSize))),console.log(n,"chunks"),s.postMessage({chunks:n,filename:i.name}),console.log(s,"worker")},r=e.ref(0);s.onmessage=async function(u){const{filename:c,hash:i}=u.data,f=await fetch(`${a.options.checkFileUrl}?hash=${i}`),{files:g,isExist:p}=await f.json();let h=t.value.findIndex(l=>l.name===c);if(p&&g.length===0&&t.value[h].state==="uploaded"){t.value=[...t.value.filter(l=>l.state!=="pending")],alert("文件已上传过，无需重复上传");return}const d=new Set(g),C=n.map((l,y)=>({chunk:l,index:y})).filter(({index:l})=>!d.has(`${c}-${l}`)),k=a.options.CONCURRENT_LIMIT,_=C.length;for(let l=0;l<_;l+=k)await Promise.all(C.slice(l,l+k).map((y,N)=>v(y.chunk,l+N,c,i,_))),console.log(`已上传 ${Math.min(l+k,_)}/${_}`);await fetch(`${a.options.mergeFileUrl}?hash=${i}&filename=${c}`),n.length=0,h=t.value.findIndex(l=>l.name===c),h!==-1&&(t.value[h].state="uploaded"),t.value=[...t.value],r.value=0,a.onChange(t.value[h],t.value,"add"),console.log("所有分片上传完毕，文件已合并")};const v=async(u,c,i,f,g)=>{const p=new FormData;return p.append("filename",i),p.append("hash",f),p.append("index",c),p.append("file",u),new Promise(h=>{fetch(a.options.uploadFileUrl,{method:"POST",body:p}).then(d=>{if(console.log("上传分片:",c,"响应状态:",d.status),d.status===200)return h(d.json());throw new Error("网络错误")}).then(d=>{n.length===g?r.value=((c+1)/n.length).toFixed(2)*100:r.value=((c+1+(n.length-g))/n.length).toFixed(2)*100}).catch(d=>{console.error("上传失败:",d)})})},F=u=>{console.log(u,"file"),t.value=[...t.value.filter(c=>c.name!==u.name)],a.onChange(u,t.value,"remove")};return(u,c)=>(e.openBlock(),e.createElementBlock("div",null,[e.createVNode(j,{"on-change":m}),e.createVNode(M,{uploadFiles:t.value,percentage:r.value,onRemoveFile:F},null,8,["uploadFiles","percentage"])]))}}),L=[z,E],P=function(o){L.forEach(s=>{o.component(s.name,s)})},D={install:P};module.exports=D;
