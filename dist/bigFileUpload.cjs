"use strict";const e=require("vue"),F=(i,o)=>{const r=i.__vccOpts||i;for(const[n,l]of o)r[n]=l;return r},x=["onKeydown"],B={key:0},E={key:1,class:"progress progress-striped active"},S=["aria-valuenow"],U=Object.assign({name:"BigFileUpload"},{__name:"index",props:{options:{type:Object,default:()=>({checkFileUrl:"",uploadFileUrl:"",mergeFileUrl:"",chunkSize:1024*1024*5})}},setup(i){const o=e.shallowRef(),r=new Worker("../worker.js"),n=[],l=i,a=e.ref([]);console.log(l.options);const y=()=>{k()},k=()=>{o.value.value="",o.value.click()},_=p=>{const s=p.target.files;console.log(p,"e");const t=s[0];console.log(t.name),t.state="pending",a.value=[...a.value,t];const u=Math.ceil(t.size/l.options.chunkSize);console.log(u,"total"),n.push(...Array.from({length:u},(v,m)=>t.slice(m*l.options.chunkSize,(m+1)*l.options.chunkSize))),console.log(n,"chunks"),r.postMessage({chunks:n,filename:t.name}),console.log(r,"worker")},d=e.ref(0);return r.onmessage=async function(p){console.log(p,"e"),o.value.value="";const{filename:s,hash:t}=p.data,u=await fetch(`${l.options.checkFileUrl}?hash=${t}`),{files:v}=await u.json(),m=new Set(v),g=n.map((c,h)=>({chunk:c,index:h})).filter(({index:c})=>!m.has(`${s}-${c}`));for(const{chunk:c,index:h}of g){const f=new FormData;f.append("filename",s),f.append("hash",t),f.append("index",h),f.append("file",c),await fetch(l.options.uploadFileUrl,{method:"POST",body:f}),n.length===g.length?d.value=((h+1)/n.length).toFixed(2)*100:d.value=((h+1+(n.length-g.length))/n.length).toFixed(2)*100}await fetch(`${l.options.mergeFileUrl}?hash=${t}&filename=${s}`),n.length=0;const w=a.value.findIndex(c=>c.name===s);w!==-1&&(a.value[w].state="uploaded"),a.value=[...a.value]},(p,s)=>(e.openBlock(),e.createElementBlock("div",null,[e.createElementVNode("button",{onClick:k,onKeydown:e.withKeys(e.withModifiers(y,["self"]),["enter","space"])},"开始上传",40,x),e.createElementVNode("input",{style:{display:"none"},ref_key:"inputRef",ref:o,type:"file",id:"file",multiple:!0,onChange:_,onClick:s[0]||(s[0]=e.withModifiers(()=>{},["stop"]))},null,544),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(a.value,(t,u)=>(e.openBlock(),e.createElementBlock("li",{class:"list-group-item",key:u},[e.createElementVNode("span",null,e.toDisplayString(t.name),1),t.state==="pending"?(e.openBlock(),e.createElementBlock("span",B,"上传进度")):e.createCommentVNode("",!0),t.state==="pending"?(e.openBlock(),e.createElementBlock("div",E,[e.createElementVNode("div",{role:"progressbar",class:"progress-bar",style:e.normalizeStyle(`width:${d.value}%;`),"aria-valuenow":d.value,"aria-valuemin":"0","aria-valuemax":"100"},e.toDisplayString(d.value)+"%",13,S)])):e.createCommentVNode("",!0)]))),128))]))}}),$=F(U,[["__scopeId","data-v-06a4eff6"]]),b=[$],z=function(i){b.forEach(o=>{i.component(o.name,o)})},C={install:z};module.exports=C;
